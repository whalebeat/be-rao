{% extends "base.html" %}
{% block content %}
<div class="card p-4">
  <h3>Phân Công Người Dùng Theo Giải Chạy</h3>
  <p class="text-muted">Chọn giải chạy và phân công nhiều người dùng cùng lúc</p>
  
  {% if marathons %}
  <form method="post">
    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label fw-bold">Chọn Giải Chạy:</label>
        <select name="marathon_id" class="form-select" onchange="window.location.href='{{ url_for('admin_marathon_users') }}?marathon=' + this.value">
          {% for m in marathons %}
          <option value="{{ m.id }}" {% if selected_marathon and selected_marathon.id == m.id %}selected{% endif %}>
            {{ m.name }}
          </option>
          {% endfor %}
        </select>
      </div>
    </div>
    
    {% if selected_marathon %}
    <div class="mb-3">
      <label class="form-label fw-bold">Người dùng được phân công cho "{{ selected_marathon.name }}":</label>
      <p class="text-muted small">Chú ý: Quản trị viên và QL kho tự động có quyền truy cập tất cả giải chạy</p>
      
      {% if all_users %}
        <div class="row">
          {% for u in all_users %}
          <div class="col-md-4">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="users" value="{{ u.id }}" id="user_{{ u.id }}"
                {% if u in selected_marathon.assigned_users %}checked{% endif %}>
              <label class="form-check-label" for="user_{{ u.id }}">
                {{ u.username }}
                {% if u.role == 'storekeeper' %}
                  <span class="badge bg-success">QL kho</span>
                {% else %}
                  <span class="badge bg-primary">User</span>
                {% endif %}
              </label>
            </div>
          </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-muted">Chưa có người dùng nào (không tính quản trị viên).</p>
      {% endif %}
    </div>
    
    <div class="d-flex gap-2">
      <button type="submit" class="btn btn-primary">Lưu</button>
      <a href="{{ url_for('admin_users') }}" class="btn btn-secondary">Quay Lại</a>
    </div>
    {% endif %}
  </form>
  {% else %}
  <p class="text-muted">Chưa có giải chạy nào. Vui lòng tạo giải chạy trước.</p>
  <a href="{{ url_for('admin_dashboard') }}" class="btn btn-primary">Đi đến Quản Lý</a>
  {% endif %}
</div>
{% endblock %}
