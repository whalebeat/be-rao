{% extends "base.html" %}
{% block content %}
<div class="card p-4">
  <h3>Báo Cáo Đối Soát Kho</h3>
  <p class="text-muted">Báo cáo này dành cho quản trị viên và thủ kho để đối soát giữa xuất/nhập kho và giao/trả thiết bị</p>
  
  <div class="mb-3">
    <div class="row g-2">
      <div class="col-md-6">
        <label class="form-label">Giải chạy <span class="text-muted">(Tùy chọn)</span></label>
        <select name="marathon" id="report-marathon-select" class="form-select" onchange="onReportMarathonChange()">
          <option value="">-- Tất cả (100 bản ghi gần nhất) --</option>
          {% for m in marathons %}<option value="{{ m.id }}" {% if selected_marathon and selected_marathon==m.id|string %}selected{% endif %}>{{ m.name }}</option>{% endfor %}
        </select>
      </div>
    </div>
  </div>

  {% if selected_marathon %}
    <h5>Thống kê Đối Soát</h5>
    <div class="alert alert-info">
      <strong>Giải thích:</strong>
      <ul class="mb-0">
        <li><strong>Xuất kho vs Đã giao:</strong> Chênh lệch = Xuất kho - Đã giao (nên bằng 0)</li>
        <li><strong>Đã trả vs Nhập kho:</strong> Chênh lệch = Đã trả - Nhập kho (nên bằng 0)</li>
      </ul>
    </div>
    <table class="table table-bordered">
      <thead class="table-light">
        <tr>
          <th rowspan="2" class="align-middle">Tên thiết bị</th>
          <th colspan="3" class="text-center bg-primary text-white">Xuất kho vs Đã giao</th>
          <th colspan="3" class="text-center bg-success text-white">Đã trả vs Nhập kho</th>
        </tr>
        <tr>
          <th class="text-center">Xuất kho</th>
          <th class="text-center">Đã giao</th>
          <th class="text-center">Chênh lệch</th>
          <th class="text-center">Đã trả</th>
          <th class="text-center">Nhập kho</th>
          <th class="text-center">Chênh lệch</th>
        </tr>
      </thead>
      <tbody>
        {% for r in equipment_summary %}
        <tr {% if r.store_vs_issued_diff != 0 or r.returned_vs_store_diff != 0 %}class="table-warning"{% endif %}>
          <td>{{ r.equipment }}</td>
          <td class="text-center">{{ r.store_issued }}</td>
          <td class="text-center">{{ r.issued }}</td>
          <td class="text-center">
            {% if r.store_vs_issued_diff == 0 %}
              <span class="badge bg-success">{{ r.store_vs_issued_diff }}</span>
            {% elif r.store_vs_issued_diff > 0 %}
              <span class="badge bg-warning">+{{ r.store_vs_issued_diff }}</span>
            {% else %}
              <span class="badge bg-danger">{{ r.store_vs_issued_diff }}</span>
            {% endif %}
          </td>
          <td class="text-center">{{ r.returned }}</td>
          <td class="text-center">{{ r.store_returned }}</td>
          <td class="text-center">
            {% if r.returned_vs_store_diff == 0 %}
              <span class="badge bg-success">{{ r.returned_vs_store_diff }}</span>
            {% elif r.returned_vs_store_diff > 0 %}
              <span class="badge bg-warning">+{{ r.returned_vs_store_diff }}</span>
            {% else %}
              <span class="badge bg-danger">{{ r.returned_vs_store_diff }}</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <h5 class="mt-4">Lịch sử Xuất/Nhập Kho</h5>
    {% if store_transactions %}
      <table class="table table-sm">
        <thead>
          <tr>
            <th>Giải chạy</th>
            <th>Loại</th>
            <th>Thời gian</th>
            <th>Tên thiết bị</th>
            <th>Số lượng</th>
            <th>Người nhận/trả</th>
            <th>Người tạo</th>
          </tr>
        </thead>
        <tbody>
          {% for t in store_transactions %}
          <tr>
            <td>{{ t.marathon or '—' }}</td>
            <td>
              {% if t.type == 'store_issue' %}
                <span class="badge bg-info">Xuất kho</span>
              {% elif t.type == 'store_return' %}
                <span class="badge bg-secondary">Nhập kho</span>
              {% endif %}
            </td>
            <td>{{ t.timestamp.strftime('%Y-%m-%d %H:%M') if t.timestamp else '—' }}</td>
            <td>{{ t.equipment or '—' }}</td>
            <td>{{ t.quantity }}</td>
            <td>{{ t.person or '—' }}</td>
            <td>{{ t.created_by or '—' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="text-muted">Không có dữ liệu xuất/nhập kho.</p>
    {% endif %}
  {% else %}
    <h5>Lịch sử Xuất/Nhập Kho (100 bản ghi gần nhất)</h5>
    {% if store_transactions %}
      <table class="table table-sm">
        <thead>
          <tr>
            <th>Giải chạy</th>
            <th>Loại</th>
            <th>Thời gian</th>
            <th>Tên thiết bị</th>
            <th>Số lượng</th>
            <th>Người nhận/trả</th>
            <th>Người tạo</th>
          </tr>
        </thead>
        <tbody>
          {% for t in store_transactions %}
          <tr>
            <td>{{ t.marathon or '—' }}</td>
            <td>
              {% if t.type == 'store_issue' %}
                <span class="badge bg-info">Xuất kho</span>
              {% elif t.type == 'store_return' %}
                <span class="badge bg-secondary">Nhập kho</span>
              {% endif %}
            </td>
            <td>{{ t.timestamp.strftime('%Y-%m-%d %H:%M') if t.timestamp else '—' }}</td>
            <td>{{ t.equipment or '—' }}</td>
            <td>{{ t.quantity }}</td>
            <td>{{ t.person or '—' }}</td>
            <td>{{ t.created_by or '—' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="text-muted">Không có dữ liệu xuất/nhập kho.</p>
    {% endif %}
  {% endif %}
</div>

<script>
  function onReportMarathonChange() {
    const sel = document.getElementById('report-marathon-select');
    if (!sel) return;
    const marathon = sel.value;
    const params = new URLSearchParams(window.location.search);
    if (marathon) params.set('marathon', marathon);
    else params.delete('marathon');
    window.location.search = params.toString();
  }
</script>
{% endblock %}
